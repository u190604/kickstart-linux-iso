# Generated by Anaconda 34.25.7.6
# Generated by pykickstart v3.32
#version=RHEL9
# Install with no UI prompts
text --non-interactive

# Network information
network  --bootproto=dhcp --device=link --activate
network  --hostname=localhost.localdomain

# installation from iso file. no internet needed but make sure that packages are available in iso
cdrom
repo --name="AppStream" --baseurl=file:///run/install/repo/AppStream

%addon com_redhat_kdump --disable
%end
# Keyboard layouts
keyboard --xlayouts='us'
# System language
lang en_NZ.UTF-8

%packages --excludedocs
@core
hyperv-daemons

%end

# Run the Setup Agent on first boot
firstboot --disable

# Accept the EULA automatically
eula --agreed

# Generated using Blivet version 3.6.0
# designed for 60Gb
ignoredisk --only-use=sda
# Partition clearing information
clearpart --all --initlabel --drives=sda
# Disk partitioning information
part pv.595 --fstype="lvmpv" --ondisk=sda --size=59814
part /boot --fstype="ext4" --ondisk=sda --size=1024 --mkfsoptions="-G 4096"
part /boot/efi --fstype="efi" --ondisk=sda --size=600 --fsoptions="umask=0077,shortname=winnt"
volgroup almalinux --pesize=4096 pv.595
logvol /tmp --fstype="ext4" --size=4096 --name=tmp --vgname=almalinux --mkfsoptions="-G 4096"
logvol swap --fstype="swap" --size=4038 --name=swap --vgname=almalinux
logvol / --fstype="ext4" --size=16384 --name=root --vgname=almalinux --mkfsoptions="-G 4096"
logvol /home --fstype="ext4" --size=4096 --name=home --vgname=almalinux --mkfsoptions="-G 4096"
logvol /var --fstype="xfs" --size=31192 --name=var --vgname=almalinux

# System timezone
timezone Pacific/Auckland --utc

#Root password
rootpw --lock
user --groups=wheel --name=aglu --password=$6$WGLIdkepBgSuOtXC$E.E/8J4CXVl9gr0zR/vRx5yHGeZXAqLV9sXhhypVHiFwFyXNm9Ccrn/WYpVs6UoGnkuyDM7c2PVWh2CvPX65W1 --iscrypted --gecos="Alex Gluhov"
# Enable SSH key authentication
sshkey --username=aglu "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPHVlPdSE4jsP545CsOfQaK+z10Lp1aKINIMrY/Nmsh1 alex.gluhov@outlook.com"


# Enable firewall and set SELinux to disabled
firewall --enabled
selinux --enforcing

# System services
services --enabled="sshd,firewalld"

# Set hostname from Hyper-V host metadata
%post --log=/root/ks-post-set-hyperv-vm-name.log
cat > /usr/local/sbin/set-hyperv-vm-name.sh <<'EOF'
#!/usr/bin/env bash
set -euo pipefail

kvp_dir="/var/lib/hyperv"
hostname_value=""

get_kvp_value() {
  local key="$1"
  local file
  for file in "$kvp_dir"/.kvp_pool_*; do
    if [[ -r "$file" ]]; then
      # Pool files are binary; strings helps extract key/value pairs.
      hostname_value="$(strings -n 1 "$file" | awk -v k="$key" 'tolower($0)==tolower(k){getline; print; exit}')"
      if [[ -n "$hostname_value" ]]; then
        return 0
      fi
    fi
  done
  return 1
}

for _ in {1..30}; do
  get_kvp_value "FullyQualifiedDomainName" || true
  if [[ -n "$hostname_value" ]]; then
    hostname_value="${hostname_value%%.*}"
    break
  fi
  get_kvp_value "VirtualMachineName" || true
  if [[ -n "$hostname_value" ]]; then
    break
  fi
  sleep 2
done

if [[ -n "$hostname_value" ]]; then
  hostnamectl set-hostname "$hostname_value"
fi
EOF

chmod 0755 /usr/local/sbin/set-hyperv-vm-name.sh

cat > /etc/systemd/system/set-hyperv-vm-name.service <<'EOF'
[Unit]
Description=Set hostname from Hyper-V host metadata
After=hypervkvpd.service
Requires=hypervkvpd.service

[Service]
Type=oneshot
ExecStart=/usr/local/sbin/set-hyperv-vm-name.sh

[Install]
WantedBy=multi-user.target
EOF

systemctl enable set-hyperv-vm-name.service
%end

# Reboot after installation completes
reboot
